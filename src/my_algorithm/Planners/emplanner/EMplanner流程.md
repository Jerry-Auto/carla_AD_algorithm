# EMPlanner轨迹规划算法文档

## 概述

EMPlanner是一个基于分层优化思想的轨迹规划算法，采用"决策+优化"的框架，结合动态规划（DP）和二次规划（QP）方法，在结构化道路上生成安全、平滑的轨迹。

## 一、障碍物处理模块

### 输入
- 原始障碍物列表
- 自车状态（位置、速度、航向等）

### 处理流程
1. **速度分类**：
   - 速度 < 0.01 m/s → 静态障碍物
   - 速度 ≥ 0.01 m/s → 动态障碍物

2. **空间过滤**：
   - 静态障碍物范围：纵向[-10m, 60m]，横向[-10m, 10m]
   - 动态障碍物范围：纵向[-10m, 60m]，横向[-20m, 20m]
   - 排除自车ID对应的障碍物

3. **坐标系转换**：
   - 将障碍物投影到Frenet坐标系（基于参考线）

### 输出
- `_static_obstacles`：静态障碍物列表（类成员变量）
- `_dynamic_obstacles`：动态障碍物列表（类成员变量）

## 二、规划起点确定模块

### 三种情况处理

#### 情况1：首次运行
- **条件**：`_previous_trajectory`为空
- **处理**：
  ```
  规划起点 = 当前自车状态
  规划起点.time_stamped = 当前时间 + delta_T（默认0.1s）
  速度和加速度设为0
  ```

#### 情况2：跟踪良好
- **条件**：非首次运行，且跟踪误差满足：
  - 横向误差 < 0.5m
  - 纵向误差 < 1.5m
- **处理**：
  1. 在上一周期轨迹上查找匹配点
  2. 规划起点 = 匹配点 + delta_T时间对应的轨迹点
  3. 轨迹拼接：取匹配点前最多20个点存入`_switch_trajectory`

#### 情况3：跟踪误差大
- **条件**：非首次运行，且跟踪误差超出阈值
- **处理**：
  ```
  假设delta_T时间内加速度恒定
  使用运动学方程外推：
    x = x0 + vx0*t + 0.5*ax*t²
    y = y0 + vy0*t + 0.5*ay*t²
    v = √(vx² + vy²)
    heading = atan2(vy, vx)
  ```

## 三、路径规划模块

### 3.1 DP路径采样
- **采样网格**：
  - S方向：10米间隔，共6层（60米规划距离）
  - L方向：1米间隔，共7个采样点（-3m ~ 3m）
- **输出**：二维采样点矩阵`path_dp_sample`

### 3.2 DP路径搜索
- **代价函数**：
  ```
  cost = w_ref * Σl² + w_dl * Σdl² + w_ddl * Σddl² + w_dddl * Σdddl² + w_obs * 障碍物代价
  ```
  
- **障碍物代价分段函数**：
  ```
  distance < 3m: cost = w_obs
  3m ≤ distance < 4m: cost = 1000/(distance² + ε)
  distance ≥ 4m: cost = 0
  ```

- **算法流程**：
  1. 构建DP节点表，记录每个节点的最小代价和前驱节点
  2. 逐层计算：当前节点代价 = 前驱节点最小代价 + 转移代价
  3. 回溯得到最优路径

### 3.3 路径加密
- **目的**：增加路径点密度，便于后续处理
- **方法**：在相邻DP路径点间用五次多项式插值
- **输出**：1米间隔的加密路径`final_dp_path`

### 3.4 凸空间生成
- **道路边界**：
  ```
  上边界 = 1.5 * lane_width - 安全距离
  下边界 = -0.5 * lane_width + 安全距离
  ```

- **障碍物处理**：
  1. 查找障碍物对应的路径索引
  2. 确定绕行方向：
     - 左侧绕行 → 抬升下边界
     - 右侧绕行 → 降低上边界
  3. 调整影响区域：障碍物前后各2.5米

- **输出**：
  - `final_dp_path_l_min`：每个路径点的最小l值
  - `final_dp_path_l_max`：每个路径点的最大l值

### 3.5 QP路径优化
- **优化变量**：每个路径点的[l, dl, ddl]
- **目标函数**：
  ```
  min: w_ref*||l - l_ref||² + w_dl*||dl||² + w_ddl*||ddl||² + 
       w_dddl*||Δddl||² + w_mid*||l - l_mid||² +
       w_l_end*(l_end - l_desire)² + w_dl_end*(dl_end)² + w_ddl_end*(ddl_end)²
  ```

- **约束条件**：
  1. **连续性约束**：位置、速度、加速度连续
  2. **碰撞约束**：车辆轮廓在凸空间内
  3. **起点约束**：与规划起点匹配

- **求解器**：OSQP

## 四、速度规划模块

### 4.1 ST图生成
- **输入**：动态障碍物的Frenet坐标
- **处理**：计算障碍物进入/离开自车路径区域的时间
  ```
  若障碍物初始在界外且向界内移动：
    t_in = |l/l_dot| - |Δl/l_dot|
    t_out = |l/l_dot| + |Δl/l_dot|
  
  若障碍物初始在界内：
    t_in = 0
    t_out = (Δl - l)/l_dot  （向上移动）
          或 (-Δl - l)/l_dot （向下移动）
  ```

- **输出**：ST图障碍物带列表`dynamic_obs_st_graph`

### 4.2 DP速度采样
- **时间采样**：0.5秒间隔，规划到8秒
- **距离采样**：自适应策略
  ```
  起始间隔：0.5米
  每10个采样点间隔翻倍
  ```

### 4.3 DP速度搜索
- **代价函数**：
  ```
  cost = w_ref_speed*(s_dot - ref_speed)² + w_a*s_dot_dot² + w_jerk*s_dot_dot_dot² + w_obs*障碍物代价
  ```

- **障碍物代价**：
  计算采样点到障碍物ST线段的最近距离，按距离分段计算代价

### 4.4 速度凸空间
- **动力学约束**：
  ```
  s_dot_max = √(a_max / |kappa|)
  其中a_max = 0.2 * 9.8 m/s²
  ```

- **障碍物约束**：
  1. 判断超车/让行：比较车辆与障碍物的相对位置
  2. 超车：提升s下边界
  3. 让行：降低s上边界

### 4.5 QP速度优化
- **优化变量**：每个时间点的[s, s_dot, s_dot_dot]
- **目标函数**：
  ```
  min: w_ref_speed*||s_dot - v_ref||² + w_a*||s_dot_dot||² + w_jerk*||Δs_dot_dot||²
  ```

- **约束条件**：
  1. 连续性约束
  2. 凸空间边界约束（s和s_dot）
  3. 非倒车约束

### 4.6 速度剖面加密
- **目的**：增加时间分辨率
- **方法**：在相邻速度点间用五次多项式插值
- **输出**：0.02秒间隔的加密速度剖面

## 五、轨迹生成模块

### 5.1 时空融合
- **输入**：
  - 路径：每个点有(s, l, dl, ddl)
  - 速度剖面：每个点有(t, s, s_dot, s_dot_dot)
  - 路径的index2s表

- **处理流程**：
  1. 对于速度剖面的每个点，根据其s值在路径上查找最近点
  2. 线性插值得到对应位置信息：
     ```
     x = x_path + (x_next - x_path) * (s - s_path)/(s_next - s_path)
     y = y_path + (y_next - y_path) * (s - s_path)/(s_next - s_path)
     heading = 同理插值
     kappa = 同理插值
     ```
  3. 组合得到完整轨迹点

### 5.2 坐标系转换
- **注意**：速度规划使用的s轴基于路径弧长，与路径规划的s轴（基于参考线）不同

## 六、轨迹拼接模块

### 6.1 拼接条件
- 仅在情况2（跟踪良好）时进行拼接
- 拼接长度：最多20个点

### 6.2 拼接方法
```
最终轨迹 = _switch_trajectory + 本次规划轨迹
```

### 6.3 作用
1. **保证连续性**：避免轨迹跳跃
2. **提高舒适性**：减少急加速/急减速
3. **减少计算量**：复用部分已规划轨迹

## 参数配置

### 路径规划权重
```cpp
_path_dp_w_ref = 200.0      // 参考线代价
_path_dp_w_dl = 300.0       // 一阶导数代价
_path_dp_w_ddl = 200.0      // 二阶导数代价
_path_dp_w_dddl = 1000.0    // 三阶导数代价
_path_dp_w_obs = 1e5        // 障碍物代价
```

### 速度规划权重
```cpp
_speed_dp_w_ref_speed = 1000.0  // 参考速度代价
_speed_dp_w_a = 300.0           // 加速度代价
_speed_dp_w_jerk = 300.0        // 加加速度代价
_speed_dp_w_obs = 1e5           // 障碍物代价
```

## 算法特点

### 优点
1. **分层优化**：路径与速度解耦，降低问题复杂度
2. **全局+局部**：DP保证全局最优性，QP保证局部平滑性
3. **凸空间思想**：将复杂约束转化为线性约束
4. **实时性**：通过轨迹拼接和热启动提高效率

### 局限性
1. **依赖参考线质量**：需要高质量的参考线作为基础
2. **简化障碍物模型**：将障碍物视为矩形或点
3. **固定采样策略**：可能错过最优解
4. **不考虑不确定性**：没有处理感知和预测误差

## 应用建议

1. **参数调优**：根据实际场景调整权重系数
2. **障碍物建模**：改进障碍物形状模型
3. **预测模块**：增加障碍物行为预测
4. **容错机制**：增加规划失败的处理策略

---

*注：本文档基于提供的代码分析，实际实现可能存在细节差异。*